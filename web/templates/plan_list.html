{% extends "base.html" %}

{% block title %}All Plans{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-history me-2"></i>
                Your Plans
            </h1>
            <a href="/" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>
                New Plan
            </a>
        </div>

        <!-- Search and Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="GET" action="/plans" id="filterForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    name="search" 
                                    placeholder="Search your plans..." 
                                    value="{{ search_query }}"
                                >
                                <button class="btn btn-outline-secondary" type="submit">
                                    <i class="fas fa-search"></i>
                                </button>
                                {% if search_query %}
                                <a href="/plans" class="btn btn-outline-danger">
                                    <i class="fas fa-times"></i>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" name="limit" onchange="updateResults()">
                                <option value="10" {% if limit == 10 %}selected{% endif %}>10 per page</option>
                                <option value="20" {% if limit == 20 %}selected{% endif %}>20 per page</option>
                                <option value="50" {% if limit == 50 %}selected{% endif %}>50 per page</option>
                                <option value="100" {% if limit == 100 %}selected{% endif %}>100 per page</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-download me-2"></i>Export
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="exportPlans('json')"><i class="fas fa-code me-2"></i>JSON</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportPlans('csv')"><i class="fas fa-table me-2"></i>CSV</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportPlans('markdown')"><i class="fas fa-file-alt me-2"></i>Markdown</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" name="page" value="{{ current_page if current_page else 1 }}">
                </form>
            </div>
        </div>

        <!-- Plans List -->
        {% if plans %}
        <div class="row">
            {% for plan in plans %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100 shadow-sm plan-card">
                    <div class="card-body d-flex flex-column">
                        <div class="mb-3">
                            <h5 class="card-title">
                                <i class="fas fa-bullseye text-primary me-2"></i>
                                Plan #{{ plan.id }}
                            </h5>
                            <p class="card-text text-muted">{{ plan.preview }}</p>
                        </div>
                        
                        <div class="row text-center mb-3">
                            <div class="col-4">
                                <small class="text-muted d-block">Steps</small>
                                <strong>{{ plan.total_steps }}</strong>
                            </div>
                            <div class="col-4">
                                <small class="text-muted d-block">Duration</small>
                                <strong class="small">{{ plan.estimated_duration }}</strong>
                            </div>
                            <div class="col-4">
                                <small class="text-muted d-block">Features</small>
                                <div>
                                    {% if plan.has_web_research %}
                                    <i class="fas fa-search text-success" title="Web Research"></i>
                                    {% endif %}
                                    {% if plan.has_weather_info %}
                                    <i class="fas fa-cloud-sun text-warning" title="Weather Info"></i>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-auto">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">
                                    {{ plan.created_at[:10] }}
                                </small>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="/api/plans/{{ plan.id }}/export/json">JSON</a></li>
                                        <li><a class="dropdown-item" href="/api/plans/{{ plan.id }}/export/csv">CSV</a></li>
                                        <li><a class="dropdown-item" href="/api/plans/{{ plan.id }}/export/markdown">Markdown</a></li>
                                    </ul>
                                </div>
                            </div>
                            <a href="/plan/{{ plan.id }}" class="btn btn-outline-primary btn-sm w-100">
                                <i class="fas fa-eye me-1"></i>
                                View Details
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-folder-open fa-5x text-muted mb-4"></i>
            <h3 class="text-muted">
                {% if search_query %}
                No plans match your search
                {% else %}
                No plans created yet
                {% endif %}
            </h3>
            <p class="text-muted">
                {% if search_query %}
                Try adjusting your search terms or 
                <a href="/plans">view all plans</a>
                {% else %}
                Get started by creating your first plan!
                {% endif %}
            </p>
            {% if not search_query %}
            <a href="/" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>
                Create Your First Plan
            </a>
            {% endif %}
        </div>
        
        <!-- Pagination -->
        {% if plans and (current_page > 1 or plans|length == limit) %}
        <nav aria-label="Plans pagination">
            <ul class="pagination justify-content-center">
                {% if current_page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ current_page - 1 }}&limit={{ limit }}{% if search_query %}&search={{ search_query }}{% endif %}">
                        <i class="fas fa-chevron-left"></i> Previous
                    </a>
                </li>
                {% endif %}
                
                {% set start_page = [1, current_page - 2]|max %}
                {% set end_page = [start_page + 4, current_page + 2]|max %}
                
                {% if start_page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="?page=1&limit={{ limit }}{% if search_query %}&search={{ search_query }}{% endif %}">1</a>
                </li>
                {% if start_page > 2 %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
                {% endif %}
                
                {% for page_num in range(start_page, end_page + 1) %}
                <li class="page-item {% if page_num == current_page %}active{% endif %}">
                    <a class="page-link" href="?page={{ page_num }}&limit={{ limit }}{% if search_query %}&search={{ search_query }}{% endif %}">{{ page_num }}</a>
                </li>
                {% endfor %}
                
                {% if plans|length == limit %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ current_page + 1 }}&limit={{ limit }}{% if search_query %}&search={{ search_query }}{% endif %}">
                        Next <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
        
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.plan-card {
    transition: transform 0.2s ease-in-out;
    cursor: pointer;
}

.plan-card:hover {
    transform: translateY(-2px);
}

.plan-card .card-body {
    position: relative;
}
</style>

<script>
// Make cards clickable
document.querySelectorAll('.plan-card').forEach(card => {
    card.addEventListener('click', function(e) {
        if (e.target.tagName.toLowerCase() !== 'a' && 
            e.target.tagName.toLowerCase() !== 'button' &&
            !e.target.closest('.dropdown')) {
            const viewLink = this.querySelector('a[href*="/plan/"]');
            if (viewLink) {
                window.location.href = viewLink.href;
            }
        }
    });
});

// Update results when filters change
function updateResults() {
    document.getElementById('filterForm').submit();
}

// Export functions
function exportPlans(format) {
    const searchQuery = document.querySelector('input[name="search"]').value;
    const limit = document.querySelector('select[name="limit"]').value;
    
    let url = `/api/plans/export/${format}?limit=${limit}`;
    if (searchQuery) {
        url += `&search=${encodeURIComponent(searchQuery)}`;
    }
    
    window.location.href = url;
}

// Auto-submit search on Enter
document.querySelector('input[name="search"]').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('filterForm').submit();
    }
});
</script>
{% endblock %}